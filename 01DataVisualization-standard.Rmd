---
title: "Data Visualization"
output: 
 xaringan::moon_reader
---

<style>
div.footnotes {
position: absolute;
bottom: 0;
margin-bottom: 10px;
width: 80%;
font-size: 0.6em;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 8, fig.height= 5.25)
library(tidyverse)
library(knitr)
```

## Using graphs to answer questions

**Do cars with big engines use more fuel than cars with small engines?**

What does the relationship between engine size and fuel efficiency look like? 

- Is it positive? Negative? 
- Linear? Nonlinear?

Let's use the `mpg` data set to answer this question.
```{r eval=FALSE, echo=TRUE}
?mpg
```

<div class='footnotes'>These slides are adapted from the data visualisation chapter of the free <a href="https://r4ds.had.co.nz/data-visualisation.html">R for Data Science</a> book by Hadley Wickham and Garret Grolemund. Solutions can be found <a href="https://jrnold.github.io/r4ds-exercise-solutions/data-visualisation.html">here</a></div>


---
## The `mpg` data frame
```{r}
kable(head(mpg,10), format = 'html')
```


---
## Creating a ggplot 
To plot mpg, run this code to put `displ` on the x-axis and `hwy` on the y-axis:
```{r echo=TRUE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy))
```

---
## A basic graphing template
```{r eval=FALSE, echo=TRUE}
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>))
```

- `ggplot` draws our coordinate system that we can add layers to.
- `<DATA>` represents our saved data frame object.
- `<GEOM_FUNCTION>` represents the geometric representation of our data (e.g., in the inital graph data "points").
- `<MAPPINGS>` represents the assignment of the `x`, `y`, and other variables for our plot.

---
## Exercises
1. Run `ggplot(data = mpg)`. What do you see?
2. How many rows are in `mpg`? How many columns?
3. What does the `drv` variable describe? Read the help for `?mpg` to find out.
4. Make a scatterplot of `hwy` vs `cyl`.
5. What happens if you make a scatterplot of `class` vs `drv`? Why is the plot not useful?

---
## Aesthetic Mappings
In the plot below, one group of points (highlighted in red) seems to fall outside of the linear trend. These cars have a higher mileage than you might expect. How can you explain these cars?
```{r fig}
new.mpg <- mpg %>% 
  mutate(flag = if_else(hwy>20 & displ>5, "Y", "N"))

ggplot() + 
  geom_point(data = new.mpg %>% filter(flag=="N"), mapping = aes(x=displ, y=hwy)) +
  geom_point(data = new.mpg %>% filter(flag=="Y"), mapping = aes(x=displ, y=hwy), color = "red", size = 2.5)
```


---
## Aesthetic Mappings (color)
First, lets consider the `class` variable in our `mpg` data frame.  We can color our data points based on the automobile's `class`.
```{r echo=TRUE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class))
```


---
## Aesthetic Mappings (size)
```{r echo=TRUE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, size = class))
```


---
## Aesthetic Mappings (alpha)
```{r echo=TRUE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, alpha = class))
```


---
## Aesthetic Mappings (shape)
```{r echo=TRUE, fig.height= 4.5}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```

---
## Manually Setting Aesthetic Mappings
Finally, you can manually set aesthetic mappings by placing the mapping outside the `aes()` function.
```{r echo=TRUE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy), color = "blue")
```
---
## Exercises
1. What’s gone wrong with this code? Why are the points not blue?
  ```{r eval = FALSE, echo = TRUE}
  ggplot(data = mpg) + 
    geom_point(mapping = aes(x = displ, y = hwy, color = "blue"))
  ```
2. Which variables in `mpg` are categorical? Which variables are continuous? (Hint: type `?mpg` to read the documentation for the dataset). How can you see this information when you run `mpg`?
3. Map a continuous variable to `color`, `size`, and `shape`. How do these aesthetics behave differently for categorical vs. continuous variables?
4. What happens if you map the same variable to multiple aesthetics?
5. What does the stroke aesthetic do? What shapes does it work with? (Hint: use `?geom_point`)
6. What happens if you map an aesthetic to something other than a variable name, like `aes(colour = displ < 5)`? Note, you’ll also need to specify x and y.

---
## CMS Public Data 
The data used in these slides is public data located on the CMS page [here](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Chronic-Conditions/index.html).
```{r, echo=F}
ccdat <- read.csv("data/chronic-conditions.csv")

trim <- function (x) gsub("^\\s+|\\s+$", "", x)
ccdat$state <- trim(ccdat$state)

alldat <- ccdat[ccdat$age=="All" & ccdat$state=="National",]

ut.diabetes <- ccdat[ccdat$state=="Utah" &
                       ccdat$age=="All" & 
                       ccdat$chronicCondition=="Diabetes",]

kable(head(ccdat), format = "html")
```

To read the data into R run the following code:

```{r echo=TRUE, eval=FALSE}
setwd("C:\\path\\to\\folder")
# setwd("C:/path/to/folder")
ccdat <- read.csv("chronic-conditions.csv")
```

---
## CMS Public Data Prep
```{r, echo=T, message=F, warning=F}
library(tidyverse)
ccdat <- read.csv("data/chronic-conditions.csv")

trim <- function (x) gsub("^\\s+|\\s+$", "", x)
ccdat$state <- trim(ccdat$state)
ccdat$year <- as.numeric(ccdat$year)

alldat <- ccdat %>% 
  filter(age=="All", state=="National")
```
```{r}
kable(head(alldat, 3), format = "html")
```

---
## Geometric objects (One Variable) - Histograms
```{r echo=TRUE}
ggplot(data = alldat) + 
  geom_histogram(mapping = aes(x=prevalence))
```

---
## Geometric objects (One Variable) - Density Plots
```{r, echo=T, message=F, warning=F}
ggplot(data = alldat) + 
  geom_density(mapping = aes(x=prevalence))
```

---
## Exercises
Consider the following code for exercises 1-3:
```{r eval=FALSE, echo=TRUE}
ggplot(data = alldat) + 
  geom_histogram(mapping = aes(x=prevalence))
```
1. What happens when you add the `geom_histogram(binwidth=5)` mapping?
2. What happens when you change the geometric object to `geom_density()`?
3. Can you tweak the code from exercise 2 to generate the density by `gender`?


---
## Geometric objects (Two Variables) - Scatter Plot
```{r, echo=T, message=F, warning=F}
ggplot(data = alldat) +
  geom_point(mapping = aes(x=year, y=prevalence))
```

---
## Geometric objects (Two Variables) - Boxplots
```{r, echo=T, message=F, warning=F}
ggplot(data = alldat) + 
  geom_boxplot(mapping = aes(x=as.factor(year), y=prevalence))
```

---
## Geometric objects (Two Variables) - Smoothing
```{r, echo=T, message=F, warning=F}
ggplot(data = alldat) + 
  geom_smooth(mapping = aes(x=year, y=prevalence), method=lm)
```

---
## Geometric objects (Two Variables) - Regression line on a scatter plot
```{r, echo=T, message=F, warning=F, fig.height=4}
ggplot(data = alldat) + 
  geom_point(mapping = aes(x=year,y=prevalence)) + 
  geom_smooth(mapping = aes(x=year,y=prevalence), method=lm)
```

<div class='footnotes'>With <code>ggplot</code> it is very easy to layer on multiple geometric representations of our data. This flexibility allows us to generate almost any graph we can imagine.</div>


---
## Geometric objects (Two Variables) - Bar Graphs
```{r, echo=T, message=F, warning=F, fig.height=4}
ut.diabetes <- ccdat %>% 
  filter(state=="Utah", age=="All", chronicCondition=="Diabetes")

ggplot(data = ut.diabetes) + 
  geom_bar(aes(x=year, y=prevalence, fill=gender), stat="identity", position="dodge")
```

<div class='footnotes'>Note: Bar graphs typically are created using one categorical variable in a data frame.  When dealing with summarized data you need to pass the <code>geom_bar()</code> function both an <code>x</code> and <code>y</code> variable along with the option: <code>stat = 'identity'</code> to let <code>ggplot</code> know you have already summarized your data. <code>position = 'dodge'</code> allows you to do side-by-side bar graphs.</div>

---
## Exercises
1. What `geom` would you use to draw a line chart? A boxplot? A histogram? An area chart?
2. What happens when you exclude `as.factor()` and run the following code?
  ```{r, echo=T, eval=F}
  ggplot(data = alldat) + 
    geom_boxplot(mapping = aes(x=as.factor(year), y=prevalence))
  ```
3. What happens when you move both of the the `mapping` arguments into the `ggplot()` function?
  ```{r, echo=T, eval=F}
  ggplot(data = alldat) + 
    geom_point(mapping = aes(x=year,y=prevalence)) + 
    geom_smooth(mapping = aes(x=year,y=prevalence), method=lm)
  ```
4. What does `method=lm` do in the code above? What happens when you remove it?
5. Use `alldat` and generate a combined scatter plot and line graph colored by `chronicCondition`. What do you see?  Are there any issues?


---
## Faceting
```{r, echo=T, message=F, warning=F}
ggplot(data = alldat, mapping = aes(x=year, y=prevalence, color=chronicCondition)) + 
  geom_point() + 
  geom_line()
```

---
## Faceting cont.
```{r, echo=T, message=F, warning=F}
ggplot(data = alldat, mapping = aes(x=year, y=prevalence, color=chronicCondition)) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~gender)
```

---
## Faceting cont.
```{r, echo=T, message=F, warning=F}
ggplot(data = alldat, mapping = aes(x=year, y=prevalence, color=gender)) + 
  geom_point() + 
  geom_line() + 
  facet_grid(gender~chronicCondition)
```

---
## Exercises
1. Take the following example and switch the `color` and `facet` variables. Which plot do you prefer and why?
  ```{r, echo=T, eval=F}
  ggplot(data = alldat, mapping = aes(x=year, y=prevalence, color=chronicCondition)) + 
    geom_point() + 
    geom_line() + 
    facet_wrap(~gender)
  ```
2. For exercise 1, what happens when you add `ncol=4` to the `facet_wrap()` function?

---
## Citation

- [ggplot2 Cheat Sheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)
- CMS Medicare Chronic Conditions data from [cms.gov](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Chronic-Conditions/index.html)
- [R Graphics Cookbook](http://www.cookbook-r.com/Graphs/) by Winston Chang
- [R for Data Science](https://r4ds.had.co.nz/) by Garrett Grolemund and Hadley Wickham
- [R for Data Science: Exercise Solutions](https://jrnold.github.io/r4ds-exercise-solutions/) by Jeffrey B. Arnold

---
# Questions?